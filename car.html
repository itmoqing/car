<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能小车控制</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .control-panel {
            text-align: center;
            margin: 30px 0;
        }
        .direction-btn {
            width: 80px;
            height: 80px;
            margin: 5px;
            font-size: 20px;
            border: none;
            border-radius: 10px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        .direction-btn:active {
            background: #45a049;
        }
        .stop-btn {
            width: 120px;
            height: 50px;
            margin: 10px;
            font-size: 18px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
        }
        .stop-btn:active {
            background: #da190b;
        }
        .status-panel {
            margin: 20px 0;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 8px;
        }
        .status-item {
            margin: 10px 0;
            font-size: 16px;
        }
        .connection-status {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
        }
        .connected {
            background: #d4edda;
            color: #155724;
        }
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>智能小车控制</h1>
        
        <div class="connection-status" id="connectionStatus">
            连接中...
        </div>

        <div class="status-panel">
            <div class="status-item">设备ID: <span id="deviceIdDisplay">-</span></div>
            <div class="status-item">连接状态: <span id="mqttStatus">断开</span></div>
            <div class="status-item">当前速度: <span id="currentSpeed">0</span></div>
        </div>

        <div class="control-panel">
            <!-- 方向控制按钮 -->
            <div>
                <button class="direction-btn" data-cmd="e">前进</button>
            </div>
            <div>
                <button class="direction-btn" data-cmd="l">左转</button>
                <button class="stop-btn" data-cmd="c">停止</button>
                <button class="direction-btn" data-cmd="r">右转</button>
            </div>
            <div>
                <button class="direction-btn" data-cmd="b">后退</button>
            </div>
        </div>

        <div class="status-panel">
            <h3>传感器数据</h3>
            <div class="status-item">状态: <span id="light">waiting...</span></div>
        </div>
    </div>

    <script>
        function getQueryParam(param) {
            const url = window.location.href;
            const regex = new RegExp('[?&]' + param + '=([^&#]*)');
            const results = regex.exec(url);
            if (results === null) {
                return null;
            } else {
                return decodeURIComponent(results[1]) || '';
            }
        }

        // MQTT相关变量
        let mqttClient = null;
        const deviceId = getQueryParam('did') || 'itmoqing1';
        let currentSpeed = 50; // 默认速度50%

        // 显示设备ID
        document.getElementById('deviceIdDisplay').textContent = deviceId;

        const clientId = 'mqttjs_' + Math.random().toString(16).substr(2, 8);
        const host = 'ws://itmojun.com:8083/mqtt';
        const options = {
            keepalive: 60,
            clientId: clientId,
            protocolId: 'MQTT',
            protocolVersion: 4,
            clean: true,
            reconnectPeriod: 1000,
            connectTimeout: 30 * 1000,
            will: {
                topic: 'WillMsg',
                payload: 'Connection Closed abnormally..!',
                qos: 0,
                retain: false
            },
        };

        // 连接 MQTT 服务器
        const client = mqtt.connect(host, options);

        // 如果连接 MQTT 服务器成功
        client.on('connect', function() {
            console.log('MQTT Connected');
            document.getElementById('mqttStatus').textContent = '已连接';
            document.getElementById('connectionStatus').textContent = 'MQTT连接成功';
            document.getElementById('connectionStatus').className = 'connection-status connected';

            // 订阅传感器主题
            client.subscribe(deviceId + '/sensor/+', function(err) {
                if (!err) {
                    console.log('订阅传感器主题成功');
                }
            });

            // 订阅设备状态主题
            client.subscribe(deviceId + '/state/+', function(err) {
                if (!err) {
                    console.log('订阅状态主题成功');
                }
            });
        });

        // 连接断开
        client.on('close', function() {
            document.getElementById('mqttStatus').textContent = '断开';
            document.getElementById('connectionStatus').textContent = 'MQTT连接断开';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });

        // 接收服务器消息
        client.on('message', function(topic, message) {
            console.log('Received Message: ' + topic + ' : ' + message.toString());

            if (topic === deviceId + '/sensor/light') {
                const lightValue = parseInt(message.toString());
                document.getElementById('light').innerText = '正常 ';
            }
            else if (topic === deviceId + '/state/car') {
                // 处理小车状态更新
                const state = message.toString();
                document.getElementById('currentSpeed').textContent = state;
            }
        });

        // 方向按钮控制
        document.querySelectorAll('.direction-btn, .stop-btn').forEach(button => {
            button.addEventListener('click', function() {
                const command = this.getAttribute('data-cmd');
                sendCarCommand(command);
            });
        });

        // 键盘控制
        document.addEventListener('keydown', function(e) {
            let command = '';
            switch(e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    command = 'e'; // 前进
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    command = 'b'; // 后退
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    command = 'l'; // 左转
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    command = 'r'; // 右转
                    break;
                case ' ':
                    command = 'c'; // 停止
                    break;
            }
            if (command) {
                sendCarCommand(command);
                e.preventDefault(); // 防止页面滚动
            }
        });

        // 防止按钮重复点击
        let lastCommandTime = 0;
        const commandCooldown = 200; // 200毫秒冷却时间

        function sendCarCommand(command) {
            const now = Date.now();
            if (now - lastCommandTime < commandCooldown) {
                return;
            }
            lastCommandTime = now;
            
            console.log('Sending command:', command);
            client.publish(deviceId + '/cmd', command);
            
            // 更新界面状态
            if (command === 'c') {
                document.getElementById('currentSpeed').textContent = '0';
            } else {
                document.getElementById('currentSpeed').textContent = currentSpeed;
            }
        }
    </script>
</body>
</html>